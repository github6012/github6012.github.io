# QHSF-HSD 校园开发者社区管理系统 - 技术开发文档

## 文档信息

- **项目名称**: QHSF-HSD 校园开发者社区管理系统
- **文档版本**: v1.0
- **编写日期**: 2025年11月
- **技术栈**: Flask + SQLAlchemy + Bootstrap + SQLite
- **审核状态**: 待审核

## 1. 开发环境配置

### 1.1 系统要求
- **操作系统**: Windows 10/11, macOS 10.15+, Ubuntu 18.04+
- **Python版本**: Python 3.8+
- **内存要求**: 最小4GB，推荐8GB+
- **磁盘空间**: 最小2GB可用空间
- **网络要求**: 能够访问PyPI和GitHub

### 1.2 开发工具推荐
- **IDE**: PyCharm Professional, Visual Studio Code, Sublime Text
- **版本控制**: Git 2.20+
- **数据库工具**: DB Browser for SQLite, DBeaver
- **API测试**: Postman, Insomnia
- **浏览器**: Chrome 90+, Firefox 88+（用于前端调试）

### 1.3 环境搭建步骤

#### 1.3.1 克隆项目
```bash
git clone ~~
cd community-system
```

#### 1.3.2 创建虚拟环境
```bash
# Windows
python -m venv venv
venv\Scripts\activate

# macOS/Linux
python3 -m venv venv
source venv/bin/activate
```

#### 1.3.3 安装依赖
```bash
pip install -r requirements.txt
```

#### 1.3.4 环境变量配置
创建 `.env` 文件：
```env
# 应用配置
FLASK_APP=app.py
FLASK_ENV=development
FLASK_DEBUG=True

# 数据库配置
DATABASE_URL=sqlite:///community.db

# 安全配置
SECRET_KEY=your-secret-key-here
WTF_CSRF_SECRET_KEY=your-csrf-key-here

# 文件上传配置
UPLOAD_FOLDER=static/uploads
MAX_CONTENT_LENGTH=5242880  # 5MB

# 邮件配置（可选）
MAIL_SERVER=smtp.gmail.com
MAIL_PORT=587
MAIL_USE_TLS=True
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD=your-app-password
```

#### 1.3.5 初始化数据库
```bash
flask db init
flask db migrate -m "Initial migration"
flask db upgrade
```

#### 1.3.6 创建管理员账户
```bash
python create_admin.py
```

### 1.4 开发服务器启动
```bash
# 开发模式启动
flask run

# 或者直接运行
python app.py
```

访问 `http://localhost:5000` 查看应用。

## 2. 项目结构详解

### 2.1 目录结构
```
community-system/
├── app.py                 # 主应用文件
├── requirements.txt      # 依赖包列表
├── .env                  # 环境变量
├── .gitignore           # Git忽略文件
├── README.md            # 项目说明
├── docs/                # 项目文档
│   ├── 需求规格说明书.md
│   ├── 项目计划书.md
│   ├── 系统架构设计文档.md
│   ├── 数据库设计文档.md
│   ├── API接口文档.md
│   ├── 技术开发文档.md
│   ├── 测试文档.md
│   └── 用户手册.md
├── templates/           # HTML模板
│   ├── base.html        # 基础模板
│   ├── admin/           # 管理后台模板
│   └── frontend/        # 前台模板
├── static/              # 静态文件
│   ├── css/             # 样式文件
│   ├── js/              # JavaScript文件
│   ├── images/          # 图片文件
│   └── uploads/         # 上传文件

```

### 2.2 核心文件说明

#### 2.2.1 app.py - 主应用文件
```python
from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate
from config import Config

# 应用实例化
app = Flask(__name__)
app.config.from_object(Config)

# 扩展初始化
db = SQLAlchemy(app)
migrate = Migrate(app, db)

# 导入模型和视图
from models import *
from views import *

if __name__ == '__main__':
    app.run(debug=True)
```

#### 2.2.2 config.py - 配置文件
```python
import os
from dotenv import load_dotenv

load_dotenv()

class Config:
    # 基础配置
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'dev-secret-key'
    
    # 数据库配置
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL') or \
        'sqlite:///community.db'
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    
    # 文件上传配置
    UPLOAD_FOLDER = 'static/uploads'
    MAX_CONTENT_LENGTH = 5 * 1024 * 1024  # 5MB
    
    # 分页配置
    POSTS_PER_PAGE = 10
    
    # 邮件配置
    MAIL_SERVER = os.environ.get('MAIL_SERVER')
    MAIL_PORT = int(os.environ.get('MAIL_PORT') or 587)
    MAIL_USE_TLS = os.environ.get('MAIL_USE_TLS', 'true').lower() in \
        ['true', 'on', '1']
    MAIL_USERNAME = os.environ.get('MAIL_USERNAME')
    MAIL_PASSWORD = os.environ.get('MAIL_PASSWORD')
```

## 3. 编码规范

### 3.1 Python编码规范

#### 3.1.1 基本规范
- 遵循 PEP 8 编码规范
- 使用4个空格进行缩进，不使用Tab
- 每行代码长度不超过88字符
- 使用UTF-8编码
- 文件末尾保留一个空行

#### 3.1.2 命名规范
```python
# 变量和函数：小写字母+下划线
user_name = "张三"
def get_user_info():
    pass

# 常量：大写字母+下划线
MAX_FILE_SIZE = 5242880
DEFAULT_PAGE_SIZE = 10

# 类名：驼峰命名法
class UserManager:
    pass

# 私有变量/方法：前缀下划线
class User:
    def __init__(self):
        self._private_var = None
    
    def _private_method(self):
        pass
```

#### 3.1.3 导入规范
```python
# 标准库导入
import os
import sys
from datetime import datetime

# 第三方库导入
from flask import Flask, request, jsonify
from sqlalchemy import Column, Integer, String

# 本地应用导入
from models.user import User
from utils.helpers import format_date
```

#### 3.1.4 注释规范
```python
def calculate_age(birth_date):
    """
    计算年龄
    
    Args:
        birth_date (datetime): 出生日期
        
    Returns:
        int: 年龄
        
    Raises:
        ValueError: 当出生日期无效时抛出
    """
    if not isinstance(birth_date, datetime):
        raise ValueError("出生日期必须是datetime对象")
    
    today = datetime.now()
    age = today.year - birth_date.year
    
    # 检查是否已过生日
    if today.month < birth_date.month or \
       (today.month == birth_date.month and today.day < birth_date.day):
        age -= 1
    
    return age
```

### 3.2 数据库模型规范

#### 3.2.1 模型定义规范
```python
from app import db
from datetime import datetime

class News(db.Model):
    """新闻模型"""
    
    __tablename__ = 'news'
    
    # 主键
    id = db.Column(db.Integer, primary_key=True)
    
    # 基本字段
    title = db.Column(db.String(200), nullable=False, comment='标题')
    content = db.Column(db.Text, nullable=False, comment='内容')
    summary = db.Column(db.String(500), comment='摘要')
    
    # 分类和标签
    category = db.Column(db.String(50), default='general', comment='分类')
    tags = db.Column(db.String(200), comment='标签')
    
    # 状态字段
    is_published = db.Column(db.Boolean, default=False, comment='是否发布')
    is_featured = db.Column(db.Boolean, default=False, comment='是否推荐')
    
    # 统计字段
    view_count = db.Column(db.Integer, default=0, comment='浏览次数')
    
    # 时间字段
    created_at = db.Column(db.DateTime, default=datetime.utcnow, comment='创建时间')
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, 
                          onupdate=datetime.utcnow, comment='更新时间')
    published_at = db.Column(db.DateTime, comment='发布时间')
    
    # 外键关联
    author_id = db.Column(db.Integer, db.ForeignKey('admin.id'), comment='作者ID')
    
    # 关系定义
    author = db.relationship('Admin', backref='news_articles')
    
    def __repr__(self):
        return f'<News {self.title}>'
    
    def to_dict(self):
        """转换为字典格式"""
        return {
            'id': self.id,
            'title': self.title,
            'content': self.content,
            'summary': self.summary,
            'category': self.category,
            'tags': self.tags,
            'is_published': self.is_published,
            'is_featured': self.is_featured,
            'view_count': self.view_count,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None,
            'published_at': self.published_at.isoformat() if self.published_at else None,
            'author_id': self.author_id
        }
```

#### 3.2.2 模型方法规范
```python
class User(db.Model):
    # ... 字段定义 ...
    
    @classmethod
    def create(cls, **kwargs):
        """创建用户"""
        user = cls(**kwargs)
        db.session.add(user)
        db.session.commit()
        return user
    
    @classmethod
    def get_by_id(cls, user_id):
        """根据ID获取用户"""
        return cls.query.get(user_id)
    
    @classmethod
    def get_by_email(cls, email):
        """根据邮箱获取用户"""
        return cls.query.filter_by(email=email).first()
    
    def update(self, **kwargs):
        """更新用户信息"""
        for key, value in kwargs.items():
            if hasattr(self, key):
                setattr(self, key, value)
        db.session.commit()
    
    def delete(self):
        """删除用户"""
        db.session.delete(self)
        db.session.commit()
```

### 3.3 视图函数规范

#### 3.3.1 路由定义规范
```python
from flask import Blueprint, request, jsonify, render_template
from models.news import News
from utils.decorators import login_required
from utils.validators import validate_news_data

# 创建蓝图
news_bp = Blueprint('news', __name__, url_prefix='/news')

@news_bp.route('/', methods=['GET'])
def news_list():
    """新闻列表页面"""
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 10, type=int)
    category = request.args.get('category', 'all')
    
    # 构建查询
    query = News.query.filter_by(is_published=True)
    if category != 'all':
        query = query.filter_by(category=category)
    
    # 分页查询
    pagination = query.paginate(
        page=page, 
        per_page=per_page, 
        error_out=False
    )
    
    return render_template('news/list.html', 
                         news_list=pagination.items,
                         pagination=pagination)

@news_bp.route('/<int:news_id>')
def news_detail(news_id):
    """新闻详情页面"""
    news = News.query.get_or_404(news_id)
    
    # 增加浏览次数
    news.view_count += 1
    db.session.commit()
    
    return render_template('news/detail.html', news=news)

@news_bp.route('/api', methods=['POST'])
@login_required
def create_news():
    """创建新闻API"""
    try:
        # 验证数据
        data = request.get_json()
        errors = validate_news_data(data)
        if errors:
            return jsonify({'code': 400, 'message': '数据验证失败', 'errors': errors}), 400
        
        # 创建新闻
        news = News.create(**data)
        
        return jsonify({
            'code': 201,
            'message': '新闻创建成功',
            'data': news.to_dict()
        }), 201
        
    except Exception as e:
        return jsonify({'code': 500, 'message': str(e)}), 500
```

#### 3.3.2 错误处理规范
```python
from flask import jsonify
from werkzeug.exceptions import HTTPException

@app.errorhandler(404)
def not_found_error(error):
    """404错误处理"""
    if request.path.startswith('/api/'):
        return jsonify({
            'code': 404,
            'message': '资源不存在',
            'timestamp': datetime.utcnow().isoformat()
        }), 404
    return render_template('errors/404.html'), 404

@app.errorhandler(500)
def internal_error(error):
    """500错误处理"""
    db.session.rollback()
    if request.path.startswith('/api/'):
        return jsonify({
            'code': 500,
            'message': '服务器内部错误',
            'timestamp': datetime.utcnow().isoformat()
        }), 500
    return render_template('errors/500.html'), 500

@app.errorhandler(HTTPException)
def handle_http_exception(error):
    """通用HTTP异常处理"""
    if request.path.startswith('/api/'):
        return jsonify({
            'code': error.code,
            'message': error.description,
            'timestamp': datetime.utcnow().isoformat()
        }), error.code
    return render_template(f'errors/{error.code}.html'), error.code
```

### 3.4 前端编码规范

#### 3.4.1 HTML规范
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}QHSF-HSD 校园开发者社区{% endblock %}</title>
    
    <!-- CSS文件 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('frontend.index') }}">
                QHSF-HSD
            </a>
            <!-- 导航菜单 -->
        </div>
    </nav>
    
    <!-- 主要内容 -->
    <main class="container mt-4">
        {% block content %}{% endblock %}
    </main>
    
    <!-- 页脚 -->
    <footer class="bg-dark text-light mt-5 py-4">
        <div class="container">
            <!-- 页脚内容 -->
        </div>
    </footer>
    
    <!-- JavaScript文件 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
```

#### 3.4.2 CSS规范
```css
/* 基础样式 */
:root {
    --primary-color: #007bff;
    --secondary-color: #6c757d;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --info-color: #17a2b8;
    --light-color: #f8f9fa;
    --dark-color: #343a40;
}

/* 通用类 */
.text-primary { color: var(--primary-color) !important; }
.bg-primary { background-color: var(--primary-color) !important; }

/* 组件样式 */
.card {
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: box-shadow 0.3s ease;
}

.card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* 响应式设计 */
@media (max-width: 768px) {
    .container {
        padding: 0 15px;
    }
    
    .card {
        margin-bottom: 1rem;
    }
}

/* 动画效果 */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fadeIn 0.5s ease-out;
}
```

#### 3.4.3 JavaScript规范
```javascript
// 使用严格模式
'use strict';

// 命名空间
const QHSF = {
    // 配置
    config: {
        apiBaseUrl: '/api',
        pageSize: 10
    },
    
    // 工具函数
    utils: {
        /**
         * 格式化日期
         * @param {Date|string} date - 日期对象或字符串
         * @returns {string} 格式化后的日期字符串
         */
        formatDate(date) {
            if (!date) return '';
            const d = new Date(date);
            return d.toLocaleDateString('zh-CN');
        },
        
        /**
         * 显示提示消息
         * @param {string} message - 消息内容
         * @param {string} type - 消息类型 (success, error, warning, info)
         */
        showMessage(message, type = 'info') {
            const alertClass = `alert-${type === 'error' ? 'danger' : type}`;
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const container = document.getElementById('message-container') || 
                            document.querySelector('.container');
            container.insertAdjacentHTML('afterbegin', alertHtml);
            
            // 3秒后自动消失
            setTimeout(() => {
                const alert = container.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 3000);
        }
    },
    
    // API调用
    api: {
        /**
         * 发送API请求
         * @param {string} endpoint - API端点
         * @param {Object} options - 请求选项
         * @returns {Promise} 请求Promise
         */
        async request(endpoint, options = {}) {
            const url = `${QHSF.config.apiBaseUrl}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            
            const finalOptions = { ...defaultOptions, ...options };
            
            try {
                const response = await fetch(url, finalOptions);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || '请求失败');
                }
                
                return data;
            } catch (error) {
                console.error('API请求错误:', error);
                throw error;
            }
        },
        
        /**
         * 获取新闻列表
         * @param {Object} params - 查询参数
         * @returns {Promise} 新闻列表数据
         */
        async getNews(params = {}) {
            const query = new URLSearchParams(params).toString();
            return this.request(`/news?${query}`);
        }
    },
    
    // 页面初始化
    init() {
        // DOM加载完成后执行
        document.addEventListener('DOMContentLoaded', () => {
            this.bindEvents();
            this.initComponents();
        });
    },
    
    // 绑定事件
    bindEvents() {
        // 表单提交事件
        document.querySelectorAll('form[data-ajax]').forEach(form => {
            form.addEventListener('submit', this.handleFormSubmit.bind(this));
        });
        
        // 分页链接事件
        document.querySelectorAll('.pagination a').forEach(link => {
            link.addEventListener('click', this.handlePagination.bind(this));
        });
    },
    
    // 初始化组件
    initComponents() {
        // 初始化工具提示
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(tooltipTriggerEl => {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // 初始化模态框
        const modalList = [].slice.call(document.querySelectorAll('.modal'));
        modalList.map(modalEl => {
            return new bootstrap.Modal(modalEl);
        });
    },
    
    // 处理表单提交
    async handleFormSubmit(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await this.api.request(form.action, {
                method: form.method || 'POST',
                body: JSON.stringify(data)
            });
            
            this.utils.showMessage(response.message, 'success');
            
            // 重置表单
            form.reset();
            
        } catch (error) {
            this.utils.showMessage(error.message, 'error');
        }
    },
    
    // 处理分页
    handlePagination(event) {
        event.preventDefault();
        
        const link = event.target;
        const url = new URL(link.href);
        const page = url.searchParams.get('page');
        
        // 更新页面内容
        this.loadPage(page);
    },
    
    // 加载页面内容
    async loadPage(page) {
        try {
            const response = await this.api.getNews({ page });
            // 更新页面内容的逻辑
            
        } catch (error) {
            this.utils.showMessage('加载失败', 'error');
        }
    }
};

// 初始化应用
QHSF.init();
```

## 4. 数据库操作规范

### 4.1 查询优化
```python
# 使用索引字段进行查询
users = User.query.filter_by(email=email).first()

# 使用分页避免大量数据查询
pagination = News.query.filter_by(is_published=True)\
    .order_by(News.created_at.desc())\
    .paginate(page=page, per_page=per_page)

# 使用join避免N+1查询问题
news_with_authors = News.query\
    .join(Admin)\
    .options(db.joinedload(News.author))\
    .all()

# 使用select_related预加载关联数据
events = Event.query\
    .options(db.selectinload(Event.participants))\
    .all()
```

### 4.2 事务处理
```python
from app import db

def transfer_points(from_user_id, to_user_id, points):
    """积分转移事务示例"""
    try:
        # 开始事务
        from_user = User.query.get(from_user_id)
        to_user = User.query.get(to_user_id)
        
        if from_user.points < points:
            raise ValueError("积分不足")
        
        # 执行转移
        from_user.points -= points
        to_user.points += points
        
        # 记录日志
        log = PointsLog(
            from_user_id=from_user_id,
            to_user_id=to_user_id,
            points=points,
            operation='transfer'
        )
        db.session.add(log)
        
        # 提交事务
        db.session.commit()
        
    except Exception as e:
        # 回滚事务
        db.session.rollback()
        raise e
```

### 4.3 数据验证
```python
from sqlalchemy.orm import validates
from sqlalchemy import event

class User(db.Model):
    email = db.Column(db.String(120), unique=True, nullable=False)
    phone = db.Column(db.String(20))
    
    @validates('email')
    def validate_email(self, key, email):
        """邮箱格式验证"""
        import re
        pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
        if not re.match(pattern, email):
            raise ValueError("邮箱格式不正确")
        return email
    
    @validates('phone')
    def validate_phone(self, key, phone):
        """手机号格式验证"""
        if phone and not phone.isdigit():
            raise ValueError("手机号只能包含数字")
        return phone

# 使用事件监听器
@event.listens_for(User, 'before_insert')
def receive_before_insert(mapper, connection, target):
    """插入前的处理"""
    target.created_at = datetime.utcnow()

@event.listens_for(User, 'before_update')
def receive_before_update(mapper, connection, target):
    """更新前的处理"""
    target.updated_at = datetime.utcnow()
```

## 5. 安全开发规范

### 5.1 输入验证
```python
from flask_wtf import FlaskForm
from wtforms import StringField, TextAreaField, BooleanField
from wtforms.validators import DataRequired, Length, Email, ValidationError
from wtforms.widgets import TextArea

class NewsForm(FlaskForm):
    """新闻表单"""
    title = StringField('标题', validators=[
        DataRequired(message='标题不能为空'),
        Length(min=3, max=200, message='标题长度必须在3-200字符之间')
    ])
    
    content = TextAreaField('内容', validators=[
        DataRequired(message='内容不能为空'),
        Length(min=10, message='内容至少10个字符')
    ], widget=TextArea())
    
    category = StringField('分类', validators=[
        DataRequired(message='分类不能为空')
    ])
    
    is_published = BooleanField('立即发布')
    
    def validate_title(self, field):
        """自定义标题验证"""
        # 检查是否包含敏感词
        sensitive_words = ['敏感词1', '敏感词2']
        for word in sensitive_words:
            if word in field.data:
                raise ValidationError(f'标题不能包含敏感词: {word}')
```

### 5.2 SQL注入防护
```python
# 正确的参数化查询
def get_user_by_email(email):
    return User.query.filter(User.email == email).first()

# 使用text()时的参数绑定
from sqlalchemy import text

def get_news_by_category(category):
    sql = text("SELECT * FROM news WHERE category = :category AND is_published = 1")
    return db.session.execute(sql, {'category': category}).fetchall()

# 避免字符串拼接（错误示例）
# sql = f"SELECT * FROM users WHERE email = '{email}'"  # 危险！
```

### 5.3 XSS防护
```python
from markupsafe import Markup, escape
from flask import Markup as FlaskMarkup

def safe_render_content(content):
    """安全渲染用户内容"""
    # 转义HTML标签
    escaped_content = escape(content)
    
    # 允许特定的安全标签
    allowed_tags = ['p', 'br', 'strong', 'em', 'ul', 'ol', 'li']
    # 使用bleach库进行白名单过滤
    import bleach
    clean_content = bleach.clean(
        escaped_content, 
        tags=allowed_tags,
        strip=True
    )
    
    return Markup(clean_content)

# 在模板中使用
# {{ content|safe }}  # 只有经过safe_render_content处理的内容才使用safe过滤器
```

### 5.4 CSRF防护
```python
from flask_wtf.csrf import CSRFProtect

# 启用CSRF保护
csrf = CSRFProtect(app)

# 在表单中包含CSRF令牌
class ContactForm(FlaskForm):
    # ... 其他字段 ...
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # CSRF令牌会自动添加

# 在模板中
# {{ form.hidden_tag() }}  # 包含CSRF令牌
```

### 5.5 文件上传安全
```python
import os
from werkzeug.utils import secure_filename
from PIL import Image

ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif'}
MAX_FILE_SIZE = 5 * 1024 * 1024  # 5MB

def allowed_file(filename):
    """检查文件扩展名"""
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

def secure_upload(file):
    """安全的文件上传处理"""
    if not file or file.filename == '':
        raise ValueError("没有选择文件")
    
    if not allowed_file(file.filename):
        raise ValueError("不支持的文件类型")
    
    # 检查文件大小
    file.seek(0, os.SEEK_END)
    file_size = file.tell()
    file.seek(0)
    
    if file_size > MAX_FILE_SIZE:
        raise ValueError("文件大小超过限制")
    
    # 安全的文件名
    filename = secure_filename(file.filename)
    
    # 生成唯一文件名
    import uuid
    ext = filename.rsplit('.', 1)[1].lower()
    unique_filename = f"{uuid.uuid4().hex}.{ext}"
    
    # 保存文件
    upload_path = os.path.join(app.config['UPLOAD_FOLDER'], unique_filename)
    file.save(upload_path)
    
    # 验证图片文件
    try:
        with Image.open(upload_path) as img:
            img.verify()  # 验证图片完整性
    except Exception:
        os.remove(upload_path)
        raise ValueError("无效的图片文件")
    
    return unique_filename
```

## 6. 测试开发规范

### 6.1 单元测试
```python
import unittest
from app import app, db
from models.user import User

class UserModelTestCase(unittest.TestCase):
    """用户模型测试"""
    
    def setUp(self):
        """测试前准备"""
        self.app = app
        self.app_context = self.app.app_context()
        self.app_context.push()
        db.create_all()
    
    def tearDown(self):
        """测试后清理"""
        db.session.remove()
        db.drop_all()
        self.app_context.pop()
    
    def test_user_creation(self):
        """测试用户创建"""
        user = User(
            name='测试用户',
            email='test@example.com',
            student_id='20240001'
        )
        db.session.add(user)
        db.session.commit()
        
        self.assertIsNotNone(user.id)
        self.assertEqual(user.name, '测试用户')
        self.assertEqual(user.email, 'test@example.com')
    
    def test_user_validation(self):
        """测试用户验证"""
        # 测试邮箱格式验证
        with self.assertRaises(ValueError):
            user = User(
                name='测试用户',
                email='invalid-email',  # 无效邮箱
                student_id='20240001'
            )
            db.session.add(user)
            db.session.commit()

if __name__ == '__main__':
    unittest.main()
```

### 6.2 API测试
```python
import json
from flask_testing import TestCase
from app import app, db

class APITestCase(TestCase):
    """API接口测试"""
    
    def create_app(self):
        app.config['TESTING'] = True
        app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///:memory:'
        return app
    
    def setUp(self):
        db.create_all()
        # 创建测试数据
        self.create_test_data()
    
    def tearDown(self):
        db.session.remove()
        db.drop_all()
    
    def create_test_data(self):
        """创建测试数据"""
        from models.admin import Admin
        admin = Admin(
            username='admin',
            email='admin@test.com'
        )
        admin.set_password('password123')
        db.session.add(admin)
        db.session.commit()
    
    def test_news_api(self):
        """测试新闻API"""
        # 测试获取新闻列表
        response = self.client.get('/api/news')
        self.assertEqual(response.status_code, 200)
        
        data = json.loads(response.data)
        self.assertEqual(data['code'], 200)
        self.assertIn('news', data['data'])
    
    def test_admin_login(self):
        """测试管理员登录"""
        response = self.client.post('/admin/login', 
            data=json.dumps({
                'username': 'admin',
                'password': 'password123'
            }),
            content_type='application/json'
        )
        
        self.assertEqual(response.status_code, 200)
        data = json.loads(response.data)
        self.assertEqual(data['code'], 200)
        self.assertEqual(data['message'], '登录成功')
```

### 6.3 集成测试
```python
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

class IntegrationTestCase(unittest.TestCase):
    """集成测试"""
    
    def setUp(self):
        self.driver = webdriver.Chrome()
        self.driver.implicitly_wait(10)
    
    def tearDown(self):
        self.driver.quit()
    
    def test_user_registration_flow(self):
        """测试用户注册流程"""
        driver = self.driver
        
        # 访问注册页面
        driver.get("http://localhost:5000/apply")
        
        # 填写表单
        driver.find_element(By.NAME, "name").send_keys("测试用户")
        driver.find_element(By.NAME, "student_id").send_keys("20240001")
        driver.find_element(By.NAME, "email").send_keys("test@student.edu.cn")
        
        # 提交表单
        driver.find_element(By.CSS_SELECTOR, "button[type='submit']").click()
        
        # 验证结果
        success_message = WebDriverWait(driver, 10).until(
            EC.presence_of_element_located((By.CLASS_NAME, "alert-success"))
        )
        self.assertIn("申请提交成功", success_message.text)
```

## 7. 性能优化规范

### 7.1 数据库优化
```python
# 使用数据库索引
class News(db.Model):
    # ... 其他字段 ...
    
    # 创建索引
    __table_args__ = (
        db.Index('idx_news_category_published', 'category', 'is_published'),
        db.Index('idx_news_created_at', 'created_at'),
    )

# 查询优化
def get_published_news(category=None, page=1, per_page=10):
    """优化的新闻查询"""
    query = News.query.filter_by(is_published=True)
    
    if category:
        query = query.filter_by(category=category)
    
    # 使用索引字段排序
    query = query.order_by(News.created_at.desc())
    
    # 只查询需要的字段
    query = query.options(
        db.load_only(News.id, News.title, News.summary, News.created_at)
    )
    
    return query.paginate(page=page, per_page=per_page)
```

### 7.2 缓存策略
```python
from flask_caching import Cache

# 配置缓存
cache = Cache(app, config={
    'CACHE_TYPE': 'redis',
    'CACHE_REDIS_URL': 'redis://localhost:6379/0'
})

@cache.memoize(timeout=300)  # 缓存5分钟
def get_hot_news():
    """获取热门新闻（带缓存）"""
    return News.query.filter_by(is_published=True)\
        .order_by(News.view_count.desc())\
        .limit(10).all()

@cache.cached(timeout=600, key_prefix='statistics')  # 缓存10分钟
def get_site_statistics():
    """获取网站统计数据（带缓存）"""
    return {
        'total_news': News.query.count(),
        'total_events': Event.query.count(),
        'total_students': Student.query.count()
    }

# 缓存失效
def invalidate_news_cache():
    """清除新闻相关缓存"""
    cache.delete_memoized(get_hot_news)
    cache.delete('statistics')
```

### 7.3 静态资源优化
```python
# 静态文件压缩
from flask_compress import Compress

compress = Compress(app)

# CDN配置
app.config['CDN_DOMAIN'] = 'https://cdn.example.com'

def cdn_url(filename):
    """生成CDN URL"""
    if app.config.get('CDN_DOMAIN'):
        return f"{app.config['CDN_DOMAIN']}/static/{filename}"
    return url_for('static', filename=filename)

# 在模板中使用
# <link href="{{ cdn_url('css/main.css') }}" rel="stylesheet">
```

## 8. 部署规范

### 8.1 生产环境配置
```python
# config.py
class ProductionConfig(Config):
    """生产环境配置"""
    DEBUG = False
    TESTING = False
    
    # 数据库配置
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL') or \
        'postgresql://user:password@localhost/community_prod'
    
    # 安全配置
    SECRET_KEY = os.environ.get('SECRET_KEY')
    WTF_CSRF_SECRET_KEY = os.environ.get('WTF_CSRF_SECRET_KEY')
    
    # 日志配置
    LOG_LEVEL = 'INFO'
    LOG_FILE = '/var/log/community/app.log'
    
    # 缓存配置
    CACHE_TYPE = 'redis'
    CACHE_REDIS_URL = os.environ.get('REDIS_URL')
    
    # 邮件配置
    MAIL_SERVER = os.environ.get('MAIL_SERVER')
    MAIL_PORT = int(os.environ.get('MAIL_PORT') or 587)
    MAIL_USE_TLS = True
    MAIL_USERNAME = os.environ.get('MAIL_USERNAME')
    MAIL_PASSWORD = os.environ.get('MAIL_PASSWORD')
```

### 8.2 Docker部署
```dockerfile
# Dockerfile
FROM python:3.9-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 创建非root用户
RUN useradd -m -u 1000 appuser && chown -R appuser:appuser /app
USER appuser

# 暴露端口
EXPOSE 5000

# 启动命令
CMD ["gunicorn", "--bind", "0.0.0.0:5000", "--workers", "4", "app:app"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=production
      - DATABASE_URL=postgresql://postgres:password@db:5432/community
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis
    volumes:
      - ./static/uploads:/app/static/uploads

  db:
    image: postgres:13
    environment:
      - POSTGRES_DB=community
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:6-alpine
    volumes:
      - redis_data:/data

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - web

volumes:
  postgres_data:
  redis_data:
```

### 8.3 监控和日志
```python
import logging
from logging.handlers import RotatingFileHandler
import os

def setup_logging(app):
    """配置日志"""
    if not app.debug and not app.testing:
        # 文件日志
        if not os.path.exists('logs'):
            os.mkdir('logs')
        
        file_handler = RotatingFileHandler(
            'logs/community.log',
            maxBytes=10240000,  # 10MB
            backupCount=10
        )
        
        file_handler.setFormatter(logging.Formatter(
            '%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'
        ))
        
        file_handler.setLevel(logging.INFO)
        app.logger.addHandler(file_handler)
        
        app.logger.setLevel(logging.INFO)
        app.logger.info('Community system startup')

# 性能监控
from flask import request, g
import time

@app.before_request
def before_request():
    g.start_time = time.time()

@app.after_request
def after_request(response):
    if hasattr(g, 'start_time'):
        duration = time.time() - g.start_time
        app.logger.info(f'{request.method} {request.path} - {response.status_code} - {duration:.3f}s')
    return response
```

## 9. 代码质量保证

### 9.1 代码检查工具
```bash
# 安装代码检查工具
pip install flake8 black isort mypy

# .flake8 配置文件
[flake8]
max-line-length = 88
exclude = migrations/
ignore = E203, W503

# pyproject.toml 配置文件
[tool.black]
line-length = 88
target-version = ['py38']
include = '\.pyi?$'
exclude = '''
/(
    \.git
  | \.mypy_cache
  | \.tox
  | \.venv
  | _build
  | buck-out
  | build
  | dist
  | migrations
)/
'''

[tool.isort]
profile = "black"
multi_line_output = 3
line_length = 88
```

### 9.2 Git
```bash
#!/bin/sh
# .git/hooks/pre-commit

# 运行代码格式化
black .
isort .

# 运行代码检查
flake8 .

# 运行类型检查
mypy .

# 运行测试
python -m pytest tests/

# 如果有错误，阻止提交
if [ $? -ne 0 ]; then
    echo "代码检查失败，请修复后再提交"
    exit 1
fi
```

### 9.3 持续集成
```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_community
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Run linting
      run: |
        flake8 .
        black --check .
        isort --check-only .
    
    - name: Run type checking
      run: mypy .
    
    - name: Run tests
      run: |
        python -m pytest tests/ --cov=./ --cov-report=xml
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost/test_community
    
    - name: Upload coverage
      uses: codecov/codecov-action@v1
      with:
        file: ./coverage.xml
```

## 10. 文档维护

### 10.1 代码文档
```python
def calculate_user_score(user_id: int, period: str = 'month') -> float:
    """
    计算用户积分
    
    根据用户在指定时间段内的活动情况计算积分。积分计算规则：
    - 发布新闻：10分
    - 参与活动：5分
    - 评论互动：2分
    
    Args:
        user_id (int): 用户ID
        period (str): 统计周期，可选值：'day', 'week', 'month', 'year'
                     默认为 'month'
    
    Returns:
        float: 用户积分，保留2位小数
    
    Raises:
        ValueError: 当用户ID无效或周期参数错误时抛出
        DatabaseError: 当数据库查询失败时抛出
    
    Example:
        >>> calculate_user_score(123, 'month')
        85.50
        
        >>> calculate_user_score(456, 'week')
        23.00
    
    Note:
        积分计算基于用户的实际活动记录，不包括管理员手动调整的积分。
        
    See Also:
        get_user_activities(): 获取用户活动记录
        update_user_score(): 更新用户积分
    """
    # 实现代码...
```

### 10.2 API文档自动生成
```python
from flask_restx import Api, Resource, fields
from flask_restx import Namespace

# 创建API文档
api = Api(app, doc='/docs/', title='QHSF-HSD API', version='1.0')

# 定义命名空间
news_ns = Namespace('news', description='新闻相关接口')

# 定义数据模型
news_model = api.model('News', {
    'id': fields.Integer(required=True, description='新闻ID'),
    'title': fields.String(required=True, description='新闻标题'),
    'content': fields.String(required=True, description='新闻内容'),
    'category': fields.String(description='新闻分类'),
    'is_published': fields.Boolean(description='是否发布'),
    'created_at': fields.DateTime(description='创建时间')
})

@news_ns.route('/')
class NewsList(Resource):
    @news_ns.doc('list_news')
    @news_ns.marshal_list_with(news_model)
    def get(self):
        """获取新闻列表"""
        return News.query.all()
    
    @news_ns.doc('create_news')
    @news_ns.expect(news_model)
    @news_ns.marshal_with(news_model, code=201)
    def post(self):
        """创建新闻"""
        # 实现代码...
        pass

api.add_namespace(news_ns, path='/api/news')
```

## 11. 故障排查指南

### 11.1 常见问题及解决方案

#### 11.1.1 数据库连接问题
```python
# 问题：数据库连接失败
# 解决方案：
def check_database_connection():
    """检查数据库连接"""
    try:
        db.session.execute('SELECT 1')
        print("数据库连接正常")
        return True
    except Exception as e:
        print(f"数据库连接失败: {e}")
        return False

# 在应用启动时检查
if not check_database_connection():
    print("请检查数据库配置和服务状态")
    sys.exit(1)
```

#### 11.1.2 内存泄漏问题
```python
# 问题：SQLAlchemy会话未正确关闭
# 解决方案：
@app.teardown_appcontext
def close_db(error):
    """确保数据库会话正确关闭"""
    db.session.remove()

# 使用上下文管理器
from contextlib import contextmanager

@contextmanager
def db_transaction():
    """数据库事务上下文管理器"""
    try:
        db.session.begin()
        yield db.session
        db.session.commit()
    except Exception:
        db.session.rollback()
        raise
    finally:
        db.session.close()

# 使用示例
with db_transaction() as session:
    user = User(name='测试用户')
    session.add(user)
```

#### 11.1.3 性能问题排查
```python
import time
from functools import wraps

def performance_monitor(func):
    """性能监控装饰器"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        start_time = time.time()
        result = func(*args, **kwargs)
        end_time = time.time()
        
        duration = end_time - start_time
        if duration > 1.0:  # 超过1秒的慢查询
            app.logger.warning(f'慢查询警告: {func.__name__} 耗时 {duration:.2f}秒')
        
        return result
    return wrapper

# 使用示例
@performance_monitor
def get_complex_data():
    # 复杂的数据查询
    pass
```

### 11.2 日志分析
```python
import re
from collections import defaultdict

def analyze_access_logs(log_file):
    """分析访问日志"""
    stats = defaultdict(int)
    error_count = 0
    
    with open(log_file, 'r') as f:
        for line in f:
            # 解析日志行
            if 'ERROR' in line:
                error_count += 1
            
            # 统计访问路径
            path_match = re.search(r'(GET|POST|PUT|DELETE) (/\S*)', line)
            if path_match:
                method, path = path_match.groups()
                stats[f'{method} {path}'] += 1
    
    print(f"错误数量: {error_count}")
    print("访问统计:")
    for path, count in sorted(stats.items(), key=lambda x: x[1], reverse=True)[:10]:
        print(f"  {path}: {count}")
```

## 12. 更新日志

### 12.1 版本历史
| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v1.0 | 2024-11-20 | 初始版本，包含完整的开发规范和指南 |

### 12.2 待完善内容
- [ ] 微服务架构迁移指南
- [ ] 容器化部署最佳实践
- [ ] 自动化测试覆盖率提升
- [ ] 性能监控和告警系统
- [ ] 安全审计和漏洞扫描

---

**文档状态**: 初稿完成  
**审核状态**: 待审核  
**维护负责人**: github6012  
**下次更新**: 根据项目发展情况更新